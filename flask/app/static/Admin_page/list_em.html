<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <!-- Bootstrap -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
      integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
      crossorigin="anonymous"
    />
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
    <!-- Bootstrap Table -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.css"
    />
    <script src="https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js"></script>
    <!-- our own css -->
    <link rel="stylesheet" href="/static/css/phonebook.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Employee Management</title>
  </head>

  <body>
    <div id="add-edit" class="container" hidden="hidden">
      <div id="header" class="container">
        <h1>Employee Management</h1>
      </div>
      <div id="add-edit" class="container">
        <h2 id="add-edit-caption">Add/Edit an Employee:</h2>
        <form id="addEmployeeForm">
          <label for="firstname">First Name</label>
          <input
            type="text"
            id="firstname"
            name="firstname"
            placeholder="First Name.."
            required
          />
          
          <label for="lastname">Last Name</label>
          <input
            type="text"
            id="lastname"
            name="lastname"
            placeholder="Last Name.."
            required
          />
          
          <label for="phone">Phone</label>
          <input
            type="text"
            id="phone"
            name="phone"
            placeholder="Phone Number.."
            required
          />
          
          <label for="role">Role</label>
          <input
            type="text"
            id="role"
            name="role"
            placeholder="Role.."
            required
          />
          
          <input type="hidden" id="employee_id" name="id" />
          <input type="submit" name="submit" value="Submit" />
          <button id="clear_form" type="button">Clear</button>
          <button id="cancel_form" type="button">Cancel</button>
        </form>
      </div>
    </div>
    &nbsp;
    <div id="table_display" class="container">
      <button id="add_employee" type="button">Create Employee</button>
      <p></p><br />
      <h2>Employees:</h2>
      <table class="table-striped border-success" id="employee-table">
        <thead>
          <tr>
            <th data-field="firstname">
              <span class="text-success"> First Name </span>
            </th>
            <th data-field="lastname">
              <span class="text-success"> Last Name </span>
            </th>
            <th data-field="phone">
              <span class="text-success"> Phone </span>
            </th>
            <th data-field="role">
              <span class="text-success"> Role </span>
            </th>
            <th
              data-field="operation"
              data-formatter="actionFormatter"
              data-events="operateEvents"
            >
              <span class="text-success"> Edit/Delete </span>
            </th>
          </tr>
        </thead>
      </table>
    </div>

    <script>
      function populate_table(table_data) {
        $('#employee-table').bootstrapTable({
          data: table_data,
        })
      }

      $(document).ready(function () {
        ;(function () {
          $.getJSON('/em/ems', populate_table)
        })()
      })

      function refresh_table(table_data) {
        $('#employee-table').bootstrapTable('load', table_data)
      }

      $('#addEmployeeForm').submit(function (event) {
        // prevent default html form submission action
        event.preventDefault()

        // pack the inputs into a dictionary
        var formData = {}
        $(':input').each(function () {
          var key = $(this).attr('name')
          var val = $(this).val()
          if (key != 'submit') {
            formData[key] = val
          }
        })

        var $form = $(this)
        var url = '/em'

        // make a POST call to the back end w/ a callback to refresh the table
        $.post(url, formData, function (table_data) {
          refresh_table(table_data)
          clearForm()
          toggleView()
        })
      })

      function clearForm() {
        $('#addEmployeeForm')[0].reset()
      }

      function toggleView() {
        if ($('#table_display').attr('hidden')) {
          $('#table_display').removeAttr('hidden')
          $('#add-edit').attr('hidden', 'hidden')
        } else {
          $('#table_display').attr('hidden', 'hidden')
          $('#add-edit').removeAttr('hidden')
        }
      }

      function actionFormatter(value, row, index) {
        return [
          '<a class="edit" href="javascript:void(0)" title="Edit">',
          '‚úèÔ∏è',
          '</a>  ',
          '<a class="remove" href="javascript:void(0)" title="Remove">',
          'üóëÔ∏è',
          '</a>',
        ].join('')
      }

      window.operateEvents = {
        'click .edit': function (e, value, row, index) {
          prePopulateForm(row)
        },
        'click .remove': function (e, value, row, index) {
          removeItem(row)
        },
      }

      function prePopulateForm(row) {
        $('#addEmployeeForm')[0].reset();
        $('#employee_id').val(row.id);
        $('#firstname').val(row.firstname);
        $('#lastname').val(row.lastname);
        $('#phone').val(row.phone);
        $('#role').val(row.role);
        toggleView();
      }

      function removeItem(row) {
        if (!confirm('Delete employee with ID ' + row.id + '?')) {
          return false
        }
        var url = '/em/remove_em'
        var formData = { id: row.id }
        $.post(url, formData, function (table_data) {
          refresh_table(table_data)
        })
      }

      $('#add_employee').click(function () {
        clearForm()
        toggleView()
      })

      $('#clear_form').click(function () {
        clearForm()
      })

      $('#cancel_form').click(function () {
        clearForm()
        toggleView()
      })
    </script>
  </body>
</html>