{% extends 'cashier_page/base.html' %}

{% block content %}
<div class="section">
    <div class="container">
        <div class="card">

            <!-- Card Header -->
            <header class="card-header">
                <h1 class="card-header-title is-size-3">Table Availability</h1>
            </header>

            <!-- Card Content (Table) -->
            <div class="card-content">
                <table id="table-list" class="table is-fullwidth is-hoverable" data-toggle="table" data-search="true"
                    data-pagination="true" data-page-size="5" data-page-list="[5, 10, 20, 50]">
                    <thead>
                        <tr>
                            <th data-field="table_id" data-sortable="true">Table No.</th>
                            <th data-field="status" data-sortable="false">Status</th>
                            <th data-field="qrcode" data-sortable="false">QR Code</th>
                        </tr>
                    </thead>
                </table>
            </div>

            <!-- Card Footer -->
            <footer class="card-footer">
                <a href="#" id="refresh" class="card-footer-item" onclick="refreshTable()">Refresh List</a>
                <a href="#" id="view-all" class="card-footer-item" onclick="showAllTables()">View All</a>
                <a href="#" id="view-less" class="card-footer-item" style="display: none;" onclick="showLessTables()">
                    View less
                </a>
            </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function () {
        loadTable();
    });

    function loadTable() {
        $.getJSON('/table/get_all_table', function (data) {
            // Destroy previous table instance to avoid conflicts
            $('#table-list').bootstrapTable('destroy');

            // Initialize table
            $('#table-list').bootstrapTable({
                data: data,
                customSearch: customTableSearch,
                columns: [
                    { field: 'table_id', sortable: true },
                    { field: 'status', sortable: false, formatter: statusFormatter },
                    { field: 'qrcode', sortable: false, formatter: qrcodeFormatter }
                ]
            });
        }).fail(function (jqXHR, textStatus, error) {
            console.error("Request Failed:", textStatus, error);
        });
    }

    function refreshTable() {
        $.getJSON('/table/get_all_table', function (data) {
            console.log("Refreshing Table:", data);
            $('#table-list').bootstrapTable('load', data);
        })
    }


    function statusFormatter(value) {
        if (value === "Available") {
            return '<span class="tag is-success">Available</span>';
        } else if (value === "Occupied") {
            return '<span class="tag is-danger">Occupied</span>';
        } else if (value === "Paid") {
            return '<span class="tag is-warning">Paid</span>';
        }
        return value;
    }

    // Formatter for QR Code Column
    function qrcodeFormatter(value) {
        value = value.replace("app/", "");
        return `<img src="${value}" alt="QR Image" style="width: 100px; height: auto;">`;
    }

    function showAllTables() {
        $.getJSON('/table/get_all_table', function (data) {
            $('#view-all').hide();
            $('#view-less').show();
            $('#table-list').bootstrapTable('refreshOptions', { pageSize: data.length });
            $('#table-list').bootstrapTable('load', data);
        })
    }

    function showLessTables() {
        $.getJSON('/table/get_all_table', function (data) {
            $('#view-all').show();
            $('#view-less').hide();
            $('#table-list').bootstrapTable('refreshOptions', { pageSize: 5 });
            $('#table-list').bootstrapTable('load', data);
        })
    }

    function customTableSearch(data, searchText) {
        searchText = searchText.toLowerCase();
        return data.filter(row => {
            return Object.values(row).some(value => {
                if (value !== null) {
                    return value.toString().toLowerCase().includes(searchText);
                }
                return false;
            });
        });
    }
</script>
{% endblock %}